import { Callout, Tabs } from 'nextra/components'

# Combined Stream

Unified SSE stream for all opportunity types - odds, +EV, and arbitrage in a single connection.

```
GET /api/v1/stream/opportunities
```

<Callout type="warning">
This endpoint requires:
- **Pro tier or higher** for +EV and arbitrage detection
- **WebSocket add-on** ($99/mo) for streaming access
</Callout>

## Why Use Combined Stream?

1. **Single connection**: All opportunities in one stream
2. **Lower latency**: No switching between streams
3. **Simplified code**: One event handler for everything
4. **Efficient**: Reduces API calls and connection overhead

## Query Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `league` | string | all | Filter by league |
| `sportsbook` | string | all | Filter by sportsbook |
| `min_ev` | number | 2.0 | Minimum EV percentage |
| `min_profit` | number | 0.5 | Minimum arbitrage profit |
| `api_key` | string | - | API key (for browser EventSource) |

## Event Types

| Type | Description |
|------|-------------|
| `connected` | Connection established |
| `initial` | Initial snapshot of all opportunities |
| `ev_opportunity` | New or updated EV opportunity |
| `arbitrage` | New or updated arbitrage |
| `heartbeat` | Keep-alive (every 30 seconds) |
| `error` | Error notification |

## Message Format

All messages follow this structure:

```json
{
  "type": "ev_opportunity",
  "timestamp": "2026-01-26T10:30:00.000Z",
  "data": { ... }
}
```

## Example Requests

<Tabs items={['cURL', 'JavaScript', 'Python']}>
  <Tabs.Tab>
```bash
curl -N -H "X-API-Key: YOUR_API_KEY" \
  "https://api.sharpapi.io/api/v1/stream/opportunities?league=nba&min_ev=3.0"
```
  </Tabs.Tab>
  <Tabs.Tab>
```javascript
const eventSource = new EventSource(
  'https://api.sharpapi.io/api/v1/stream/opportunities?league=nba&min_ev=3.0&api_key=YOUR_KEY'
);

eventSource.onmessage = (event) => {
  const message = JSON.parse(event.data);

  switch (message.type) {
    case 'connected':
      console.log('Connected with config:', message.data.config);
      break;
    case 'initial':
      console.log('EV opportunities:', message.meta.evCount);
      console.log('Arbitrage opportunities:', message.meta.arbCount);
      break;
    case 'ev_opportunity':
      handleEVUpdate(message.data);
      break;
    case 'arbitrage':
      handleArbUpdate(message.data);
      break;
    case 'heartbeat':
      console.log('Stream alive at', message.timestamp);
      break;
  }
};

eventSource.onerror = (error) => {
  console.error('Stream error:', error);
};
```
  </Tabs.Tab>
  <Tabs.Tab>
```python
import requests
import json

def stream_combined(api_key, league=None, min_ev=2.0):
    params = {'min_ev': min_ev}
    if league:
        params['league'] = league

    response = requests.get(
        'https://api.sharpapi.io/api/v1/stream/opportunities',
        headers={'X-API-Key': api_key},
        params=params,
        stream=True
    )

    for line in response.iter_lines():
        if line:
            line = line.decode('utf-8')
            if line.startswith('data: '):
                data = json.loads(line[6:])
                yield data

# Usage
for message in stream_combined('YOUR_API_KEY', league='nba', min_ev=3.0):
    print(f"[{message['type']}]", message.get('data', ''))
```
  </Tabs.Tab>
</Tabs>

## Event Examples

### Connected Event

```json
{
  "type": "connected",
  "timestamp": "2026-01-26T10:30:00.000Z",
  "data": {
    "config": {
      "league": "nba",
      "minEV": 3.0,
      "minProfit": 0.5
    },
    "tier": "pro",
    "maxStreams": 10
  }
}
```

### Initial Event

```json
{
  "type": "initial",
  "timestamp": "2026-01-26T10:30:00.000Z",
  "data": {
    "ev": [
      {
        "eventId": "33483153",
        "eventName": "Los Angeles Lakers @ Boston Celtics",
        "evPercent": 4.5,
        "kellyPercent": 2.1,
        "sportsbook": "draftkings",
        "selection": "Lakers +6.5"
      }
    ],
    "arbitrage": [
      {
        "eventId": "33483200",
        "eventName": "Dallas Cowboys @ Philadelphia Eagles",
        "profitPercent": 1.8,
        "marketType": "moneyline"
      }
    ]
  },
  "meta": {
    "evCount": 12,
    "arbCount": 2
  }
}
```

### EV Opportunity Event

```json
{
  "type": "ev_opportunity",
  "timestamp": "2026-01-26T10:30:15.000Z",
  "data": {
    "eventId": "33483250",
    "eventName": "Golden State Warriors @ Denver Nuggets",
    "sport": "nba",
    "evPercent": 5.2,
    "kellyPercent": 2.8,
    "sportsbook": "fanduel",
    "selection": "Warriors ML",
    "odds": 145,
    "sharpOdds": 130,
    "sharpBook": "pinnacle",
    "detectedAt": "2026-01-26T10:30:15.000Z"
  }
}
```

### Arbitrage Event

```json
{
  "type": "arbitrage",
  "timestamp": "2026-01-26T10:30:20.000Z",
  "data": {
    "eventId": "33483300",
    "eventName": "Boston Celtics @ Miami Heat",
    "sport": "nba",
    "profitPercent": 2.1,
    "marketType": "spread",
    "legs": [
      { "sportsbook": "draftkings", "selection": "Celtics -4.5", "odds": -105, "stakePercent": 52.5 },
      { "sportsbook": "betmgm", "selection": "Heat +5.5", "odds": -105, "stakePercent": 47.5 }
    ],
    "detectedAt": "2026-01-26T10:30:20.000Z"
  }
}
```

## Best Practices

1. **Reconnection**: Implement exponential backoff

```javascript
let retries = 0;
const maxRetries = 5;

function connect() {
  const eventSource = new EventSource(url);

  eventSource.onopen = () => {
    retries = 0; // Reset on successful connection
  };

  eventSource.onerror = () => {
    eventSource.close();

    if (retries < maxRetries) {
      const delay = Math.min(1000 * Math.pow(2, retries), 30000);
      retries++;
      setTimeout(connect, delay);
    }
  };
}
```

2. **Heartbeat monitoring**: Reconnect if no message for 45 seconds
3. **Deduplication**: Track seen opportunity IDs
4. **Rate awareness**: Stream counts against concurrent limit
5. **Clean disconnection**: Close stream when done

## Connection Limits

Each open stream counts against your concurrent stream limit:

| Add-on | Max Streams |
|--------|-------------|
| WebSocket ($99/mo) | 10 |
| Enterprise | Custom |

<Callout type="info">
The combined stream is the most efficient way to receive all opportunities while only using one stream slot.
</Callout>
